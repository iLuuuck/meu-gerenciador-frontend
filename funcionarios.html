<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russo - Repasse</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="clientes.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
<div id="menuOverlay" class="menu-overlay"></div>
<div id="sidebar" class="sidebar">
    <div class="sidebar-top">
        <button id="toggleSidebar" class="toggle-btn">â˜°</button>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="inicio.html"><span class="icon">ğŸ </span> <span class="text">INÃCIO</span></a></li>
                <li><a href="clientes.html"><span class="icon">ğŸ‘¥</span> <span class="text">CLIENTES</span></a></li>
                <li><a href="funcionarios.html" class="active"><span class="icon">ğŸ’¼</span> <span class="text">REPASSE</span></a></li>
                <li><a href="perfil.html"><span class="icon">ğŸ‘¤</span> <span class="text">PERFIL</span></a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
             <button id="sidebarLogoutBtn" class="logout-btn">
                 <span class="icon">ğŸšª</span> <span class="text">Sair da Conta</span>
             </button>
        </div>
    </div>
</div>

<div class="main-content">
    <header class="header-container">
        <h2>ğŸ’¼ Repasse</h2>
        <button onclick="document.getElementById('modalPerfilFunc').style.display='flex'" class="button">+ Novo Perfil</button>
    </header>

    <div id="listaNomesFuncionarios" class="filter-actions"></div>
    <hr style="border:0; border-top:1px solid #333; margin:20px 0;">

    <div id="dashboardFuncionario" style="display: none;">
        <div class="header-container">
            <h2 id="nomeFuncionarioSelecionado" style="color: var(--primary-color);"></h2>
            <button class="button" onclick="openAddModal()">+ Novo Repasse</button>
        </div>
        <div id="repassesList" class="debtors-list"></div>
    </div>
</div>

<div id="modalPerfilFunc" class="modal">
    <div class="modal-content">
        <h3>Criar Novo Perfil</h3>
        <input type="text" id="novoNomeFunc" placeholder="Ex: NEILI" style="width:100%; padding:10px; margin:15px 0; background:#2c2c2c; color:white; border:1px solid #444; border-radius:8px;">
        <button onclick="salvarPerfilFuncionario()" class="button">Criar Repasse</button>
        <button onclick="closeModal('modalPerfilFunc')" class="button button-secondary">Cancelar</button>
    </div>
</div>

<div id="addEditDebtorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="addEditModalTitle">Novo Repasse</h2>
            <span class="close-button" onclick="closeModal('addEditDebtorModal')">&times;</span>
        </div>
        <form id="addEditDebtorForm">
            <div class="input-group">
                <label>Valor Emprestado:</label>
                <input type="number" id="loanedAmount" step="0.01" required>
            </div>
            <div class="input-group">
                <label>FrequÃªncia:</label>
                <select id="frequency" required>
                    <option value="daily">DiÃ¡rio</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                </select>
            </div>
            <div class="input-group">
                <label>Tipo de CÃ¡lculo:</label>
                <select id="calculationType" onchange="toggleCalcFields()">
                    <option value="perInstallment">Valor por Parcela</option>
                    <option value="percentage">Porcentagem de Juros</option>
                </select>
            </div>
            <div id="perInstallmentFields">
                <div class="input-group"><label>Valor por Parcela:</label><input type="number" id="amountPerInstallmentInput" step="0.01"></div>
            </div>
            <div id="percentageFields" style="display: none;">
                <div class="input-group"><label>Porcentagem de Juros (%):</label><input type="number" id="interestPercentageInput" step="0.01"></div>
            </div>
            <div class="input-group"><label>NÃºmero de Parcelas:</label><input type="number" id="installments" required></div>
            <div class="input-group"><label>Data de InÃ­cio:</label><input type="date" id="startDate" required></div>
            <div class="modal-footer"><button type="submit" class="button">Salvar</button></div>
        </form>
    </div>
</div>

<div id="debtorDetailModal" class="modal">
    <div class="modal-content payment-modal">
        <div class="modal-header">
            <h2 id="modalDebtorName">Baixar Parcela</h2>
            <span class="close-button" onclick="closeModal('debtorDetailModal')">&times;</span>
        </div>
        <div id="paymentsGrid" class="payments-grid"></div>
        <div class="payment-form">
            <div class="input-group"><label>Data</label><input type="date" id="paymentDate"></div>
            <div class="input-group"><label>Valor Pago</label><input type="number" id="paymentAmount" step="0.01"></div>
            <button id="addPaymentButton" class="btn-primary">Confirmar Pagamento</button>
        </div>
    </div>
</div>

<nav class="mobile-nav">
    <a href="inicio.html" class="nav-item"><span class="icon">ğŸ </span><span class="label">InÃ­cio</span></a>
    <a href="clientes.html" class="nav-item"><span class="icon">ğŸ‘¥</span><span class="label">Clientes</span></a>
    <a href="funcionarios.html" class="nav-item active"><span class="icon">ğŸ’¼</span><span class="label">Repasse</span></a>
    <a href="perfil.html" class="nav-item"><span class="icon">ğŸ‘¤</span><span class="label">Perfil</span></a>
</nav>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAEZVCbz39BiqTj5f129PcrVHxfS6OnzLc",
        authDomain: "gerenciadoremprestimos.firebaseapp.com",
        projectId: "gerenciadoremprestimos",
        storageBucket: "gerenciadoremprestimos.firebasestorage.app",
        messagingSenderId: "365277402196",
        appId: "1:365277402196:web:65016aa2dd316e718a89c1"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUserId = null, currentFuncId = null, currentQuadradoId = null, idParaExcluirAposRenovar = null, repasses = [];

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserId = user.uid;
            carregarPastas();
        } else {
            setTimeout(() => { if (!auth.currentUser) window.location.href = "index.html"; }, 5000);
        }
    });

    function getHojeFormatado() {
        const hoje = new Date();
        const offset = hoje.getTimezoneOffset();
        const dataLocal = new Date(hoje.getTime() - (offset * 60 * 1000));
        return dataLocal.toISOString().split('T')[0];
    }

    window.salvarPerfilFuncionario = async function() {
        const nome = document.getElementById('novoNomeFunc').value.toUpperCase().trim();
        if (!nome) return alert("Digite um nome!");
        await db.collection('lista_funcionarios').add({ nome, userId: currentUserId, createdAt: new Date().toISOString() });
        document.getElementById('novoNomeFunc').value = '';
        closeModal('modalPerfilFunc');
    };

    function carregarPastas() {
        db.collection('lista_funcionarios').where('userId', '==', currentUserId).onSnapshot(snap => {
            const container = document.getElementById('listaNomesFuncionarios');
            if (!container) return; container.innerHTML = '';
            snap.forEach(doc => {
                const btn = document.createElement('button');
                btn.className = "button button-secondary";
                btn.style.margin = "5px"; btn.innerText = doc.data().nome;
                btn.onclick = () => {
                    currentFuncId = doc.id;
                    document.getElementById('dashboardFuncionario').style.display = 'block';
                    document.getElementById('nomeFuncionarioSelecionado').innerText = "REPASSE: " + doc.data().nome;
                    setupRepassesListener();
                };
                container.appendChild(btn);
            });
        });
    }

    function setupRepassesListener() {
        db.collection('repasses_funcionarios').where('funcionarioId', '==', currentFuncId).onSnapshot(snap => {
            repasses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderRepasses();
            if (currentQuadradoId && document.getElementById('debtorDetailModal').style.display === 'flex') {
                const r = repasses.find(x => x.id === currentQuadradoId);
                if (r) document.getElementById('paymentsGrid').innerHTML = atualizarLayoutParcelas(r);
            }
        });
    }

    function renderRepasses() {
        const list = document.getElementById('repassesList');
        if (!list) return; list.innerHTML = '';
        repasses.forEach(d => {
            const paid = (d.payments || []).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const total = parseFloat(d.totalToReceive) || 0;
            const remaining = total - paid;
            const progress = total > 0 ? Math.min((paid / total) * 100, 100).toFixed(0) : 0;
            const isFinished = parseFloat(progress) >= 99.9;

            const card = document.createElement('div');
            card.className = 'debtor-card';
            card.innerHTML = `
                <h3>R$ ${parseFloat(d.loanedAmount).toFixed(2)}</h3>
                <div class="info-row"><span>Falta:</span> <strong style="color:${isFinished ? '#2ecc71' : '#e74c3c'}">R$ ${remaining.toFixed(2)}</strong></div>
                <div class="progress-container"><div class="progress-bar" style="width: ${progress}%"></div></div>
                <div class="card-footer-actions">
                    ${isFinished ? `<button onclick="renewRepasse('${d.id}')" class="btn-action" style="background:#27ae60; flex:1;">ğŸ”„ Renovar</button>` : `<button onclick="openPaymentModal('${d.id}')" class="btn-action btn-pay">Baixar</button>`}
                    <button onclick="editRepasse('${d.id}')" class="btn-action btn-edit">ğŸ“</button>
                    <button onclick="deleteRepasse('${d.id}')" class="btn-action btn-delete">ğŸ—‘ï¸</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    window.openAddModal = function() {
        currentQuadradoId = null; idParaExcluirAposRenovar = null;
        document.getElementById('addEditDebtorForm').reset();
        document.getElementById('startDate').value = getHojeFormatado();
        document.getElementById('addEditModalTitle').innerText = "Novo Repasse";
        document.getElementById('addEditDebtorModal').style.display = 'flex';
    };

    window.editRepasse = function(id) {
        currentQuadradoId = id; const d = repasses.find(r => r.id === id);
        document.getElementById('loanedAmount').value = d.loanedAmount;
        document.getElementById('installments').value = d.installments;
        document.getElementById('startDate').value = d.startDate;
        document.getElementById('addEditModalTitle').innerText = "Editar Repasse";
        document.getElementById('addEditDebtorModal').style.display = 'flex';
    };

    document.getElementById('addEditDebtorForm').onsubmit = async (e) => {
        e.preventDefault();
        const loanedAmount = parseFloat(document.getElementById('loanedAmount').value);
        const installments = parseInt(document.getElementById('installments').value);
        const calcType = document.getElementById('calculationType').value;
        let totalToReceive, amountPerInstallment;

        if (calcType === 'perInstallment') {
            amountPerInstallment = parseFloat(document.getElementById('amountPerInstallmentInput').value);
            totalToReceive = amountPerInstallment * installments;
        } else {
            let juros = parseFloat(document.getElementById('interestPercentageInput').value) || 0;
            totalToReceive = loanedAmount * (1 + juros / 100);
            amountPerInstallment = totalToReceive / installments;
        }

        const data = {
            funcionarioId: currentFuncId, loanedAmount, installments, totalToReceive, amountPerInstallment,
            frequency: document.getElementById('frequency').value, startDate: document.getElementById('startDate').value,
            userId: currentUserId, lastEdited: new Date().toISOString()
        };

        if (currentQuadradoId) {
            await db.collection('repasses_funcionarios').doc(currentQuadradoId).update(data);
        } else {
            if (idParaExcluirAposRenovar) await db.collection('repasses_funcionarios').doc(idParaExcluirAposRenovar).delete();
            data.payments = [];
            await db.collection('repasses_funcionarios').add(data);
        }
        closeModal('addEditDebtorModal');
    };

    window.openPaymentModal = function(id) {
        currentQuadradoId = id; const r = repasses.find(x => x.id === id);
        document.getElementById('paymentsGrid').innerHTML = atualizarLayoutParcelas(r);
        document.getElementById('paymentDate').value = getHojeFormatado();
        document.getElementById('paymentAmount').value = r.amountPerInstallment.toFixed(2);
        document.getElementById('debtorDetailModal').style.display = 'flex';
    };

    document.getElementById('addPaymentButton').onclick = async () => {
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const date = document.getElementById('paymentDate').value;
        if (!amount || !date) return alert("Preencha tudo!");
        await db.collection('repasses_funcionarios').doc(currentQuadradoId).update({
            payments: firebase.firestore.FieldValue.arrayUnion({ amount, date, timestamp: new Date().toISOString() })
        });
    };

    function atualizarLayoutParcelas(debtor) {
        const totalParc = parseInt(debtor.installments);
        const valParc = parseFloat(debtor.amountPerInstallment);
        let pool = (debtor.payments || []).map(p => ({ ...p, amount: parseFloat(p.amount) }));
        pool.sort((a, b) => a.date.localeCompare(b.date));
        let html = '';
        for (let i = 1; i <= totalParc; i++) {
            let pago = 0, falta = valParc, hist = '';
            for (let p of pool) {
                if (p.amount > 0 && falta > 0) {
                    let u = Math.min(p.amount, falta);
                    pago += u; p.amount -= u; falta -= u;
                    hist += `<div style="font-size:0.6rem; color:#f1c40f;">ğŸ“…${p.date.split('-').reverse().slice(0,2).join('/')}: R$${u.toFixed(0)}</div>`;
                }
            }
            let cor = pago >= valParc - 0.01 ? 'paid' : (pago > 0 ? 'partial' : 'pending');
            html += `<div class="payment-square ${cor}">
                <small>Parc ${i}</small><strong>R$${valParc.toFixed(2)}</strong>
                <div class="hist">${hist}</div>
            </div>`;
        }
        return html;
    }

    window.renewRepasse = function(id) {
        const r = repasses.find(item => item.id === id);
        idParaExcluirAposRenovar = id; currentQuadradoId = null;
        document.getElementById('loanedAmount').value = r.loanedAmount;
        document.getElementById('installments').value = r.installments;
        document.getElementById('addEditDebtorModal').style.display = 'flex';
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.deleteRepasse = async (id) => { if(confirm("Excluir?")) await db.collection('repasses_funcionarios').doc(id).delete(); };
    function toggleCalcFields() {
        const type = document.getElementById('calculationType').value;
        document.getElementById('perInstallmentFields').style.display = type === 'perInstallment' ? 'block' : 'none';
        document.getElementById('percentageFields').style.display = type === 'percentage' ? 'block' : 'none';
    }
</script>

<style>
    /* Estilos extras para os quadrados ficarem bonitos como antes */
    .payments-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; margin-bottom: 20px; }
    .payment-square { padding: 8px; border-radius: 8px; text-align: center; display: flex; flex-direction: column; min-height: 70px; border: 1px solid rgba(255,255,255,0.1); }
    .payment-square.pending { background: #333; color: #888; }
    .payment-square.partial { background: #f39c12; color: white; }
    .payment-square.paid { background: #27ae60; color: white; }
    .payment-square small { font-size: 0.65rem; opacity: 0.8; }
    .payment-square strong { font-size: 0.8rem; margin: 2px 0; }
    .hist { margin-top: 5px; line-height: 1; }
</style>
</body>
</html>
