<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Russo - Repasse</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="clientes.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
</head>
<body>
<div id="menuOverlay" class="menu-overlay"></div>
<div id="sidebar" class="sidebar">
    <div class="sidebar-top">
        <button id="toggleSidebar" class="toggle-btn">‚ò∞</button>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="inicio.html"><span class="icon">üè†</span> <span class="text">IN√çCIO</span></a></li>
                <li><a href="clientes.html"><span class="icon">üë•</span> <span class="text">CLIENTES</span></a></li>
                <li><a href="funcionarios.html" class="active"><span class="icon">üíº</span> <span class="text">REPASSE</span></a></li>
                <li><a href="perfil.html"><span class="icon">üë§</span> <span class="text">PERFIL</span></a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
             <button id="sidebarLogoutBtn" class="logout-btn">
                 <span class="icon">üö™</span> 
                 <span class="text">Sair da Conta</span>
             </button>
        </div>
    </div>
</div>

<div class="main-content">
    <header class="header-container">
        <h2>üíº Repasse</h2>
        <button onclick="document.getElementById('modalPerfilFunc').style.display='flex'" class="button">+ Novo Perfil</button>
    </header>

    <div id="listaNomesFuncionarios" class="filter-actions"></div>

    <hr style="border:0; border-top:1px solid #333; margin:20px 0;">

    <div id="dashboardFuncionario" style="display: none;">
        <div class="header-container">
            <h2 id="nomeFuncionarioSelecionado" style="color: var(--primary-color);"></h2>
            <button class="button" onclick="openAddModal()">+ Novo Repasse</button>
        </div>
        <div id="repassesList" class="debtors-list"></div>
    </div>
</div>

<div id="modalPerfilFunc" class="modal">
    <div class="modal-content">
        <h3>Criar Novo Perfil de Repasse</h3>
        <input type="text" id="novoNomeFunc" placeholder="Ex: NEILI" style="width:100%; padding:10px; margin:15px 0; background:#2c2c2c; color:white; border:1px solid #444; border-radius:8px;">
        <button onclick="salvarPerfilFuncionario()" class="button">Criar Repasse</button>
        <button onclick="document.getElementById('modalPerfilFunc').style.display='none'" class="button button-secondary">Cancelar</button>
    </div>
</div>

<div id="addEditDebtorModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="addEditModalTitle">Adicionar Novo Repasse</h2>
            <span class="close-button" onclick="closeModal('addEditDebtorModal')">&times;</span>
        </div>
        <form id="addEditDebtorForm">
            <div class="input-group">
                <label>Valor Emprestado:</label>
                <input type="number" id="loanedAmount" step="0.01" required>
            </div>
            <div class="input-group">
                <label>Frequ√™ncia:</label>
                <select id="frequency" required>
                    <option value="daily">Di√°rio</option>
                    <option value="weekly">Semanal</option>
                    <option value="monthly">Mensal</option>
                </select>
            </div>
            <div class="input-group">
                <label>Tipo de C√°lculo:</label>
                <select id="calculationType" onchange="toggleCalcFields()">
                    <option value="perInstallment">Valor por Parcela</option>
                    <option value="percentage">Porcentagem de Juros</option>
                </select>
            </div>
            <div id="perInstallmentFields">
                <div class="input-group">
                    <label>Valor por Parcela:</label>
                    <input type="number" id="amountPerInstallmentInput" step="0.01">
                </div>
            </div>
            <div id="percentageFields" style="display: none;">
                <div class="input-group">
                    <label>Porcentagem de Juros (%):</label>
                    <input type="number" id="interestPercentageInput" step="0.01">
                </div>
            </div>
            <div class="input-group">
                <label>N√∫mero de Parcelas:</label>
                <input type="number" id="installments" required>
            </div>
            <div class="input-group">
                <label>Data de In√≠cio:</label>
                <input type="date" id="startDate" required>
            </div>
            <div class="modal-footer">
                <button type="submit" class="button">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="debtorDetailModal" class="modal">
    <div class="modal-content payment-modal">
        <div class="modal-header">
            <h2 id="modalDebtorName">Baixar Parcela</h2>
            <span class="close-button" onclick="closeModal('debtorDetailModal')">&times;</span>
        </div>
        <div id="paymentsGrid" class="payments-grid"></div>
        <div class="payment-form">
            <div class="input-group"><label>Data</label><input type="date" id="paymentDate"></div>
            <div class="input-group"><label>Valor Pago</label><input type="number" id="paymentAmount" step="0.01"></div>
            <button id="addPaymentButton" class="btn-primary">Confirmar Pagamento</button>
        </div>
    </div>
</div>

<nav class="mobile-nav">
    <a href="inicio.html" class="nav-item"><span class="icon">üè†</span><span class="label">In√≠cio</span></a>
    <a href="clientes.html" class="nav-item"><span class="icon">üë•</span><span class="label">Clientes</span></a>
    <a href="funcionarios.html" class="nav-item active"><span class="icon">üíº</span><span class="label">Repasse</span></a>
    <a href="perfil.html" class="nav-item"><span class="icon">üë§</span><span class="label">Perfil</span></a>
</nav>

<script>
    // --- CONFIGURA√á√ÉO ---
    const firebaseConfig = {
        apiKey: "AIzaSyAEZVCbz39BiqTj5f129PcrVHxfS6OnzLc",
        authDomain: "gerenciadoremprestimos.firebaseapp.com",
        projectId: "gerenciadoremprestimos",
        storageBucket: "gerenciadoremprestimos.firebasestorage.app",
        messagingSenderId: "365277402196",
        appId: "1:365277402196:web:65016aa2dd316e718a89c1"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUserId = null;
    let currentFuncId = null;
    let currentQuadradoId = null;
    let idParaExcluirAposRenovar = null;
    let repasses = [];

    // --- SEGURAN√áA: REMOVIDA EXPULS√ÉO AUTOM√ÅTICA ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserId = user.uid;
            carregarPastas();
        } else {
            console.log("Aguardando login...");
            // window.location.href = "index.html"; // DESATIVADO PARA TESTE DEFINITIVO
        }
    });

    function getHojeFormatado() {
        const hoje = new Date();
        const offset = hoje.getTimezoneOffset();
        const dataLocal = new Date(hoje.getTime() - (offset * 60 * 1000));
        return dataLocal.toISOString().split('T')[0];
    }

    // --- FUN√á√ïES DE PERFIL ---
    window.salvarPerfilFuncionario = async function() {
        const nome = document.getElementById('novoNomeFunc').value.toUpperCase().trim();
        if (!nome) return alert("Digite um nome!");
        try {
            await db.collection('lista_funcionarios').add({
                nome: nome, userId: currentUserId, createdAt: new Date().toISOString()
            });
            document.getElementById('novoNomeFunc').value = '';
            document.getElementById('modalPerfilFunc').style.display = 'none';
        } catch (e) { alert("Erro ao salvar."); }
    };

    function carregarPastas() {
        db.collection('lista_funcionarios').where('userId', '==', currentUserId)
            .onSnapshot(snap => {
                const container = document.getElementById('listaNomesFuncionarios');
                if (!container) return;
                container.innerHTML = '';
                snap.forEach(doc => {
                    const f = doc.data();
                    const btn = document.createElement('button');
                    btn.className = "button button-secondary";
                    btn.style.margin = "5px";
                    btn.innerText = f.nome;
                    btn.onclick = () => {
                        currentFuncId = doc.id;
                        document.getElementById('dashboardFuncionario').style.display = 'block';
                        document.getElementById('nomeFuncionarioSelecionado').innerText = "REPASSE: " + f.nome;
                        setupRepassesListener();
                    };
                    container.appendChild(btn);
                });
            });
    }

    // --- REPASSES ---
    function setupRepassesListener() {
        db.collection('repasses_funcionarios').where('funcionarioId', '==', currentFuncId)
            .onSnapshot(snap => {
                repasses = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRepasses();
                if (currentQuadradoId && document.getElementById('debtorDetailModal').style.display === 'flex') {
                    const rAct = repasses.find(r => r.id === currentQuadradoId);
                    if (rAct) document.getElementById('paymentsGrid').innerHTML = atualizarLayoutParcelas(rAct);
                }
            });
    }

    function renderRepasses() {
        const list = document.getElementById('repassesList');
        if (!list) return;
        list.innerHTML = '';
        repasses.forEach(d => {
            const paid = (d.payments || []).reduce((sum, p) => sum + (parseFloat(p.amount) || 0), 0);
            const total = parseFloat(d.totalToReceive) || 0;
            const progress = total > 0 ? Math.min((paid / total) * 100, 100).toFixed(0) : 0;
            const isFinished = parseFloat(progress) >= 99.9;

            const card = document.createElement('div');
            card.className = 'debtor-card';
            card.innerHTML = `
                <h3>R$ ${parseFloat(d.loanedAmount).toFixed(2)}</h3>
                <div class="progress-container"><div class="progress-bar" style="width: ${progress}%"></div></div>
                <div class="card-footer-actions">
                    ${isFinished ? `<button onclick="renewRepasse('${d.id}')" class="btn-action" style="background:#27ae60; flex:1;">üîÑ Renovar</button>` : `<button onclick="openPaymentModal('${d.id}')" class="btn-action btn-pay">Baixar</button>`}
                    <button onclick="deleteRepasse('${d.id}')" class="btn-action btn-delete">üóëÔ∏è</button>
                </div>
            `;
            list.appendChild(card);
        });
    }

    window.openAddModal = function() {
        currentQuadradoId = null; idParaExcluirAposRenovar = null;
        document.getElementById('addEditDebtorForm').reset();
        document.getElementById('startDate').value = getHojeFormatado();
        document.getElementById('addEditDebtorModal').style.display = 'flex';
    };

    document.getElementById('addEditDebtorForm').onsubmit = async (e) => {
        e.preventDefault();
        const loanedAmount = parseFloat(document.getElementById('loanedAmount').value);
        const installments = parseInt(document.getElementById('installments').value);
        const calcType = document.getElementById('calculationType').value;
        let totalToReceive, amountPerInstallment;

        if (calcType === 'perInstallment') {
            amountPerInstallment = parseFloat(document.getElementById('amountPerInstallmentInput').value);
            totalToReceive = amountPerInstallment * installments;
        } else {
            let juros = parseFloat(document.getElementById('interestPercentageInput').value) || 0;
            totalToReceive = loanedAmount * (1 + juros / 100);
            amountPerInstallment = totalToReceive / installments;
        }

        const data = {
            funcionarioId: currentFuncId, loanedAmount, installments, totalToReceive, amountPerInstallment,
            frequency: document.getElementById('frequency').value, startDate: document.getElementById('startDate').value,
            userId: currentUserId, lastEdited: new Date().toISOString()
        };

        if (idParaExcluirAposRenovar) await db.collection('repasses_funcionarios').doc(idParaExcluirAposRenovar).delete();
        data.payments = [];
        await db.collection('repasses_funcionarios').add(data);
        closeModal('addEditDebtorModal');
    };

    window.openPaymentModal = function(id) {
        currentQuadradoId = id;
        const repasse = repasses.find(r => r.id === id);
        document.getElementById('paymentsGrid').innerHTML = atualizarLayoutParcelas(repasse);
        document.getElementById('paymentDate').value = getHojeFormatado();
        document.getElementById('paymentAmount').value = repasse.amountPerInstallment.toFixed(2);
        document.getElementById('debtorDetailModal').style.display = 'flex';
    };

    document.getElementById('addPaymentButton').onclick = async () => {
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        const date = document.getElementById('paymentDate').value;
        await db.collection('repasses_funcionarios').doc(currentQuadradoId).update({
            payments: firebase.firestore.FieldValue.arrayUnion({ amount, date, timestamp: new Date().toISOString() })
        });
    };

    function atualizarLayoutParcelas(debtor) {
        const totalParc = parseInt(debtor.installments);
        const valParc = parseFloat(debtor.amountPerInstallment);
        let pool = (debtor.payments || []).map(p => ({ ...p, amount: parseFloat(p.amount) }));
        let html = '';
        for (let i = 1; i <= totalParc; i++) {
            let pago = 0, falta = valParc;
            for (let p of pool) {
                if (p.amount > 0 && falta > 0) {
                    let u = Math.min(p.amount, falta);
                    pago += u; p.amount -= u; falta -= u;
                }
            }
            let cor = pago >= valParc - 0.01 ? 'paid' : (pago > 0 ? 'partial' : 'pending');
            html += `<div class="payment-square ${cor}">Parc ${i}<br>R$ ${valParc.toFixed(2)}</div>`;
        }
        return html;
    }

    window.renewRepasse = function(id) {
        const r = repasses.find(item => item.id === id);
        idParaExcluirAposRenovar = id;
        document.getElementById('loanedAmount').value = r.loanedAmount;
        document.getElementById('installments').value = r.installments;
        document.getElementById('addEditDebtorModal').style.display = 'flex';
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.deleteRepasse = async (id) => { if(confirm("Excluir?")) await db.collection('repasses_funcionarios').doc(id).delete(); };
    function toggleCalcFields() {
        const type = document.getElementById('calculationType').value;
        document.getElementById('perInstallmentFields').style.display = type === 'perInstallment' ? 'block' : 'none';
        document.getElementById('percentageFields').style.display = type === 'percentage' ? 'block' : 'none';
    }
</script>
</body>
</html>
